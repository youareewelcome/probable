<view class="container-full" id="page-posts-index">
  <view class="items-post" wx:if="{{ posts.length > 0 }}">
    <view class="item-post cu-card dynamic no-card solid-top solid-bottom"
          wx:for="{{ posts }}" wx:key="id" wx:for-item="post" wx:for-index="postIndex">
      <view class="cu-item shadow">
        <view class="cu-list menu-avatar">
          <view class="cu-item">
            <view class="cu-avatar round lg" style="background-image:url('{{ post.user_avatar }}');"></view>
            <view class="content flex-sub">
              <view>{{ post.user_nickname }}</view>
              <view class="text-gray text-sm flex justify-between">{{ post.created_at_for_humans }}</view>
            </view>
          </view>
        </view>

        <!-- 内容与图片 -->
        <view class="text-content"><text>{{ post.content }}</text></view>
        <view wx:if="{{ post.images.length > 0 }}"
              class="grid flex-sub padding-lr {{ post.images.length > 1 ? 'col-3 grid-square' : 'col-1' }}">
          <view class="bg-img {{ post.images.length > 1 ? '' : 'only-img' }}"
                style="background-image:url('{{ image.file_path }}');"
                bind:tap="previewImage" data-url="{{ image.file_path }}" data-urls="{{ post.images }}"
                wx:for="{{ post.images }}" wx:for-item="image" wx:key="*this">
          </view>
        </view>

        <!-- 操作栏 -->
        <view class="cu-list flex margin-top-sm" style="background-color:#f1f1f1;">
          <!-- 隐藏阅读数
            <view class="cu-item flex-sub padding-tb-sm margin-left-sm text-grey text-center">
              <text class="cuIcon-attention margin-lr-xs"></text> {{ post.read_num }} 阅读
            </view>
          -->
          <view class="cu-item flex-sub padding-tb-sm margin-lr-sm text-grey text-center"
                bind:tap="thumbUpHandler" data-post-id="{{ post.id }}" data-post-index="{{ postIndex }}"
                data-type="{{ 'thumb_up' }}" data-value="{{ !post.i_have_thumb_up }}">
            <text wx:if="{{ post.i_have_thumb_up }}" class="cuIcon-appreciatefill margin-lr-xs"></text>
            <text wx:else class="cuIcon-appreciate margin-lr-xs"></text>
            {{ post.thumb_up_num }} 点赞
          </view>
          <view class="cu-item flex-sub padding-tb-sm margin-right-sm text-grey text-center"
                bind:tap="openCommentPopup" data-post-id="{{ post.id }}" data-post-index="{{ postIndex }}">
            <text wx:if="{{ post.i_have_comment }}" class="cuIcon-communityfill margin-lr-xs"></text>
            <text wx:else class="cuIcon-community margin-lr-xs"></text>
            {{ post.comment_num }} 评论
          </view>
        </view>

        <!-- 评论列表 -->
        <view wx:if="{{ post.comments.length > 0 }}" class="cu-list menu-avatar comment" style="margin-top:0;">
          <view class="cu-item" wx:for="{{ post.comments }}" wx:key="id" wx:for-item="comment">
            <view class="cu-avatar round" style="background-image:url('{{ comment.user_avatar }}');"></view>
            <view class="content">
              <view class="text-grey">{{ comment.user_nickname }}</view>
              <view class="text-gray text-content text-df">{{ comment.content }}</view>
              <view class="margin-top-sm flex justify-between">
                <view class="text-gray text-df">{{ comment.created_at_for_humans }}</view>
                <view>
                  <text class="cuIcon-appreciatefill text-red"></text>
                  <text class="cuIcon-messagefill text-gray margin-left-sm"></text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <view wx:else style="padding-top:100px;">
    <van-empty description="暂无动态"></van-empty>
  </view>

  <button bind:tap="gotoCreatePage" class="btn-create cu-btn bg-blue round"><view class="icon cuIcon-post"></view></button>

  <van-popup id="popup-comment-create" show="{{ commentPopupVisible }}" round closeable
          close-icon-position="top-right" position="bottom" custom-style="height:280rpx; overflow:hidden;"
          bind:close="closeCommentPopup">
    <view class="form">
      <view class="caption">评论动态</view>
      <view class="flex flex-wrap">
        <view class="basis-xl">
          <textarea model:value="{{ commentPopupContent }}" class="textarea-content bg-gray" placeholder="说说你的看法 ..." auto-focus="true"></textarea>
        </view>
        <view class="basis-xs">
          <view class="cu-btn btn-send block text-white bg-olive" bind:tap="commentHandler">发布</view>
        </view>
      </view>
    </view>
  </van-popup>
</view>
