<view class="container-full" id="page-posts-index">
  <van-notify id="van-notify"></van-notify>

  <view class="items-post" wx:if="{{ posts.length > 0 }}">
    <view class="item-post cu-card dynamic no-card"
          wx:for="{{ posts }}" wx:key="id" wx:for-item="post" wx:for-index="postIndex">
      <view class="cu-item shadow">
        <!-- Header -->
        <view id="section-header" class="cu-list menu-avatar">
          <view class="cu-item">
            <view class="cu-avatar round lg" style="background-image:url('{{ post.user_avatar }}');"></view>
            <view class="content flex-sub">
              <view>{{ post.user_nickname }}</view>
              <view class="text-gray text-sm flex justify-between">{{ post.created_at_for_humans }}</view>
            </view>
            <view>
              <button class="btn-more cu-btn bg-white icon" bind:tap="showPostActionSheet"
                      data-post="{{ post }}" data-post-index="{{ postIndex }}">
                <text class="cuIcon-unfold"></text>
              </button>
            </view>
          </view>
        </view>

        <!-- 内容与图片 -->
        <view class="text-content"><text>{{ post.content }}</text></view>
        <view class="item-video" wx:if="{{ post.video }}">
          <video id="video-{{ post.id }}" class="video" src="{{ post.video.file_path }}" title="{{ post.content }}"
                 controls="{{ currentVideoId === ('video-' + post.id) }}"
                 bind:play="videoPlayHandler" show-mute-btn="{{ true }}"
                 enable-progress-gesture="{{ true }}" enable-play-gesture="{{ true }}" enable-auto-rotation="{{ true }}"></video>
        </view>
        <view wx:if="{{ post.images.length > 0 }}"
              class="items-image grid flex-sub padding-lr {{ post.images.length > 1 ? 'col-3 grid-square' : 'col-1' }}">
          <view class="item-image bg-img {{ post.images.length > 1 ? '' : 'only-img' }}"
                style="background-image:url('{{ image.file_path }}');"
                bind:tap="previewImage" data-url="{{ image.file_path }}" data-urls="{{ post.images }}"
                wx:for="{{ post.images }}" wx:for-item="image" wx:key="*this">
          </view>
        </view>

        <!-- 操作栏 -->
        <view id="section-actions" class="cu-list flex margin-top-sm solids-bottom">
          <view class="item-action cu-item flex-sub padding-tb-sm margin-lr-sm text-grey text-center">
            <button class="item-action-btn cu-btn bg-white padding-lr-xl"
                    bind:tap="postThumbUpHandler" data-post-id="{{ post.id }}" data-post-index="{{ postIndex }}"
                    data-type="{{ 'thumb_up' }}" data-value="{{ !post.i_have_thumb_up }}">
              <text wx:if="{{ post.i_have_thumb_up }}" class="cuIcon-appreciatefill margin-lr-xs"></text>
              <text wx:else class="cuIcon-appreciate margin-lr-xs"></text>
              <text class="text-value" wx:if="{{ post.thumb_up_num }}">{{ post.thumb_up_num }}</text>
              <text class="text-value text-sm" wx:else>点赞</text>
            </button>
          </view>
          <view class="item-action cu-item flex-sub padding-tb-sm margin-right-sm text-grey text-center">
            <button class="item-action-btn cu-btn bg-white padding-lr-xl"
                    bind:tap="openCommentPopup" data-type="comment" data-post-id="{{ post.id }}" data-post-index="{{ postIndex }}">
              <text wx:if="{{ post.i_have_comment }}" class="cuIcon-communityfill margin-lr-xs"></text>
              <text wx:else class="cuIcon-community margin-lr-xs"></text>
              <text class="text-value" wx:if="{{ post.comment_num }}">{{ post.comment_num }}</text>
              <text class="text-value text-sm" wx:else>评论</text>
            </button>
          </view>
          <view class="item-action cu-item flex-sub padding-tb-sm margin-right-sm text-grey text-center">
            <navigator open-type="navigate" url="/pages/posts/detail/index?id={{ post.id }}" class="item-action-btn cu-btn bg-white padding-lr-xl" style="width:auto;">
              <text class="cuIcon-newsfill margin-lr-xs"></text>
              <text class="text-value text-sm">详情</text>
            </navigator>
          </view>
        </view>

        <!-- 评论列表 -->
        <view id="section-comments" wx:if="{{ post.comments.length > 0 }}" class="cu-list menu-avatar comment" style="margin-top:0;">
          <view class="item-comment cu-item solid-bottom" wx:for="{{ post.comments }}" wx:key="id" wx:for-item="comment" wx:for-index="commentIndex">
            <view class="cu-avatar round" style="background-image:url('{{ comment.user_avatar }}');"></view>
            <view class="content">
              <view class="text-grey">{{ comment.user_nickname }}</view>
              <view class="text-grey text-content text-df">{{ comment.content }}</view>

              <view wx:if="{{ comment.parent }}" class="bg-gray padding-tb-xs padding-lr-sm radius margin-top-sm text-sm">
                <view class="flex">
                  <view>{{ comment.parent.user.nickname }}：</view>
                  <view class="flex-sub">{{ comment.parent.content }}</view>
                </view>
              </view>

              <view class="footer margin-top-sm flex justify-between">
                <view class="text-gray text-df">{{ comment.created_at_for_humans }}</view>
                <view class="items-btn">
                  <button class="item-btn text-gray cu-btn sm bg-white"
                          bind:tap="postCommentThumbUpHandler" data-comment-id="{{ comment.id }}"
                          data-post-index="{{ postIndex }}" data-comment-index="{{ commentIndex }}"
                          data-type="{{ 'thumb_up' }}" data-value="{{ !comment.i_have_thumb_up }}">
                    <text wx:if="{{ comment.i_have_thumb_up }}" class="cuIcon-appreciatefill"></text>
                    <text wx:else class="cuIcon-appreciate"></text>
                    <text class="margin-left-xs" wx:if="{{ comment.thumb_up_num }}">{{ comment.thumb_up_num }}</text>
                  </button>
                  <button class="item-btn text-gray cu-btn sm bg-white"
                          bind:tap="openCommentPopup" data-comment-id="{{ comment.id }}" data-type="replyComment"
                          data-post-index="{{ postIndex }}" data-comment-index="{{ commentIndex }}">
                    <text wx:if="{{ comment.i_have_comment }}" class="cuIcon-communityfill"></text>
                    <text wx:else class="cuIcon-community"></text>
                    <text class="margin-left-xs" wx:if="{{ comment.comment_num }}">{{ comment.comment_num }}</text>
                  </button>
                  <button class="item-btn text-gray cu-btn sm bg-white" bind:tap="showPostCommentActionSheet"
                          data-comment="{{ comment }}" data-post-index="{{ postIndex }}" data-comment-index="{{ commentIndex }}">
                    <text class="cuIcon-moreandroid"></text>
                  </button>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <view wx:else style="padding-top:100px;">
    <van-empty description="暂无动态"></van-empty>
  </view>

  <navigator wx:if="{{ appGlobalData.isAuth }}" url="/pages/posts/create/index" class="btn-create cu-btn bg-blue round"><view class="icon cuIcon-post"></view></navigator>
  <navigator wx:else url="/pages/users/auth/index" class="btn-create cu-btn bg-blue round"><view class="icon cuIcon-post"></view></navigator>

  <van-popup id="popup-comment-create" show="{{ commentPopupVisible }}" round closeable
          close-icon-position="top-right" position="bottom" custom-style="height:280rpx; overflow:hidden;"
          bind:close="closeCommentPopup">
    <form class="form">
      <view class="caption" wx:if="{{ commentPopupType === 'comment'}}">评论动态</view>
      <view class="caption" wx:if="{{ commentPopupType === 'replyComment' }}">参与讨论</view>
      <view class="flex flex-wrap">
        <view class="basis-xl">
          <textarea bind:input="setCommentContentHandler" value="{{ commentPopupContent }}" class="textarea-content bg-gray" placeholder="说说你的看法 ..."></textarea>
        </view>
        <view class="basis-xs">
          <button bind:tap="commentHandler" class="cu-btn btn-send block text-white bg-olive">发布</button>
        </view>
      </view>
    </form>
  </van-popup>
</view>

<mp-actionSheet bind:actiontap="postActionTapHandler" title="动态操作" show="{{ postActionSheetVisible }}" actions="{{ postActions }}" ></mp-actionSheet>
<mp-actionSheet bind:actiontap="postCommentActionTapHandler" title="评论操作" show="{{ postCommentActionSheetVisible }}" actions="{{ postCommentActions }}" ></mp-actionSheet>
