"use strict";function iapJudge(e,t){return e.orderId&&"string"==typeof e.orderId?"number"!=typeof e.amount||e.amount!==e.amount?(console.warn("请填写正确的订单金额"),!1):"string"!=typeof e.currencyType||3!==e.currencyType.length?(console.warn("请填写正确的货币类型"),!1):!t||"string"==typeof e.paymentType||void 0===e.paymentType||(console.warn("请填写正确的支付方式"),!1):(console.warn("请填写正确的订单ID"),!1)}function resetFn(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},a=e[t];e[t]=function(e){a&&a.call(this,e),n.call(this,e)}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},customConf=require("./tdweapp-conf.js"),_uidUrl="https://api.talkingdata.com/mpopenid",_requestUrl="https://h5.udrig.com/app/wx/v1",_uidKey="openId",_version=["3","0","11"],waitFlag={device:!0,network:!0,uid:!0},appInfo={sdk:{version:_version[0],minorVersion:_version[1],build:_version[2],platform:"Weapp",partner:""},app:{versionCode:customConf.config.versionCode||"1",versionName:customConf.config.versionName||"1.0.0",installTime:0,displayName:customConf.config.appName,appKey:customConf.config.appkey,uniqueId:customConf.config.wxAppid,channel:""},device:{type:"mobile",softwareConfig:{},hardwareConfig:{},deviceId:{}},networks:[{type:"wifi",available:!1,connected:!1},{type:"cellular",available:!1,connected:!1,current:[]},{type:"unknown",available:!1,connected:!1}],locations:[{}],appContext:{}},Util={firstInit:!1,initTime:0,sessionId:"",sessionStartTime:0,appLaunchInfo:{},sendFailTimes:0,bakData:{},Store:{set:function(e, t){try{wx.setStorageSync("TDSDK_"+e,t)}catch(e){}Util.bakData["TDSDK_"+e]=t},get:function(e){var t=null;try{t=wx.getStorageSync("TDSDK_"+e)}catch(e){}return t||(t=Util.bakData["TDSDK_"+e]||null),t},remove:function(e){try{wx.removeStorageSync("TDSDK_"+e)}catch(e){}delete Util.bakData["TDSDK_"+e]}},random:function(){for(var e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",t=e.length,n="",a=0; a<12; a++)n+=e.charAt(Math.floor(Math.random()*t));return n},timestamp:function(){return(new Date).getTime()},deviceId:function(){return"weapp-"+this.timestamp()+"-"+this.random()},getEventId:function(e){if(!e&&!/0{1}/.test(e))return"";var t="";try{t=e.toString()}catch(n){try{t=JSON.stringify(e)}catch(e){}}return t.split(" ")[0].slice(0,64)},addStoreData:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t="EVENT_"+Util.sessionId,n=Util.Store.get(t);n=n&&n.length?n.concat(e):e,Util.Store.set(t,n),n.length>=30&&(onLaunchFn.sessionContinue(),onLaunchFn.startLoop())},eventHandle:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e){var n=getCurrentPages(),a=n[n.length-1],i={eventId:e,label:a.__route__,count:1,startTime:Util.timestamp()};if("WeappShare"===e){i.shareTickets=t.shareTickets;var o=JSON.parse(JSON.stringify(a.options||{}));o.user=Util.deviceId,o.title=t.title,o.desc=t.desc,o.path=t.path,i.params=o}Util.addStoreData([i])}},getCacheData:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.keys(e),n=[],a=[];return t.length&&t.forEach(function(t){var i=e[t];i&&i.sendFail&&i.data&&(n=n.concat(i.data),a.push(t))}),{data:n,keys:a}},sendCacheList:{},updateSendTime:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=appInfo.device.deviceId,a=Util.Store.get("uid"),i=Util.Store.get("deviceId");return e.forEach(function(o, r){if(!o.device.deviceId.tid&&!o.device.deviceId.uid)if(n.tid){if(o.device.deviceId.tid=n.tid,n.uid)return o.device.deviceId.uid=n.uid,!0}else{if(n.uid)return o.device.deviceId.uid=n.uid,o.device.deviceId.tid=n.uid,!0;if(TDID.isWaitingForOpenid){if(a)return o.device.deviceId.uid=a,o.device.deviceId.tid=a,n.uid=a,n.tid=a,!0;if(i)o.device.deviceId.tid=i,o.device.deviceId.uid="";else{var s=Util.deviceId();n.tid=s,n.uid="",Util.Store.set("deviceId",s),o.device.deviceId.tid=s,o.device.deviceId.uid="",TDID.shouldOverwriteTid=!1}}else o.device.deviceId.tid=n.tid,o.device.deviceId.uid=n.uid}o.action&&o.action.data&&(e[r].action.data.start=t)}),e},getRequestData:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=JSON.parse(JSON.stringify(e)),n=Util.sendCacheList;if(Object.keys(n).length){var a=Util.getCacheData(n);t=t.concat(a.data),a.keys.forEach(function(e){return delete n[e]})}var i=t.length;if(i){var o=[];if(i>=30){JSON.stringify(t).length>61440&&o.push(t.splice(0,i/2)),o.push(t)}else o.push(t);o.forEach(function(e){var t=Util.timestamp();n[t]={data:e,sendFail:!1};var a=Util.updateSendTime(e,Util.timestamp());Util.request(t,a)})}},request:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];wx.request({url:_requestUrl,data:JSON.stringify(t),method:"POST",success:function(t){200===t.statusCode&&(delete Util.sendCacheList[e],Util.sendFailTimes=0,appHandle.appIsHide||(clearTimeout(onLaunchFn.timeout),onLaunchFn.timeout=null,onLaunchFn.startLoop()))},fail:function(){appHandle.appIsHide?(Util.Store.set("RESEND_"+e,t),delete Util.sendCacheList[e]):(Util.sendCacheList[e].sendFail=!0,Util.sendFailTimes<5&&Util.sendFailTimes++)}})}},TDID={shouldOverwriteTid:!0,isWaitingForOpenid:!0,isFirst:!0,init:function(){var e=this,t=Util.Store.get("deviceId"),n=Util.Store.get("uid");if(n){var a=t||n;e.setData(a,n)}else{new Promise(this.getOpenid).then(function(n){var a=void 0;t?a=t:(a=n,Util.Store.set("deviceId",n)),e.setData(a,n),Util.Store.set("uid",n),TDID.isWaitingForOpenid=!1}).catch(function(n){var a=void 0;a=t||Util.deviceId(),e.setData(a,""),TDID.shouldOverwriteTid&&Util.Store.set("deviceId",a),TDID.isWaitingForOpenid=!1})}},setData:function(e, t){TDID.shouldOverwriteTid?appInfo.device.deviceId={tid:e,uid:t}:appInfo.device.deviceId.uid=t,waitFlag.uid=!1,onLaunchFn.getAppProfile()},getOpenid:function(e, t){function n(){a.isFirst?a.reGetOpenid(e,t):t("error")}var a=TDID;(new Date).getTime();wx.login({timeout:3e3,success:function(t){if(t.code){var a=_uidUrl;wx.request({url:a+"/"+customConf.config.appkey+"/"+t.code,success:function(t){var a=t.data;a&&200===a.code&&a[_uidKey]?e(a[_uidKey]):n()},fail:function(e){n()}})}else n()},fail:function(e){n()}})},reGetOpenid:function(e, t){TDID.isFirst=!1,TDID.getOpenid(e,t)}},DomainName={placeOrder:{domain:"iap",name:"placeOrder"},orderPaySucc:{domain:"iap",name:"pay"},cancelOrder:{domain:"iap",name:"cancelOrder"},register:{domain:"account",name:"register"},login:{domain:"account",name:"login"}},request={sendTime:0,statusType:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=[],n=JSON.parse(JSON.stringify(appInfo)),a={domain:e.domain,name:e.name,data:e.data};n.ts=e.data.start||Util.timestamp(),n.action=a,t.push(n),Util.getRequestData(t)},dataType:function(e, t){var n=this.getStoreList(e,t);Util.getRequestData(n)},getEventType:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=DomainName[e.domainName];if(t)return t;if(e.pageEvent)return{domain:"page",name:"leave"};if(e.eventId){var n=e.eventId,a={};switch(n){case"WeappShare":a={domain:"user",name:"share"};break;case"WeappPullDownRefresh":a={domain:"page",name:"pullDownRefresh"};break;case"WeappReachBottom":a={domain:"page",name:"reachBottom"};break;default:a={domain:"appEvent",name:""}}return a}},getStoreList:function(e, t){var n=this,a=[],i=e||Util.sessionId,o=JSON.stringify(appInfo),r=Util.Store.get("EVENT_"+i);return r&&r.length&&(r.forEach(function(e){var i=n.getEventType(e),r=JSON.parse(o);t&&r.appContext&&(r.appContext.sessionStartTime=t);var s=JSON.parse(JSON.stringify(e)),c=s.pageEvent?s.leaveTime:s.startTime;s.pageEvent&&delete s.pageEvent,s.leaveTime&&delete s.leaveTime,s.domainName||(s.status=2),s.domainName&&delete s.domainName;var d={domain:i.domain,name:i.name,data:s};r.ts=c||Util.timestamp(),r.action=d,a.push(r)}),Util.Store.remove("EVENT_"+i)),a}},Account={switchType:function(e){var t="";switch(e){case 0:t="ANONYMOUS";break;case 1:t="REGISTERED";break;case 2:t="SINA_WEIBO";break;case 3:t="QQ";break;case 4:t="QQ_WEIBO";break;case 5:t="ND91";break;case 6:t="WEIXIN";break;case 11:t="TYPE1";break;case 12:t="TYPE2";break;case 13:t="TYPE3";break;case 14:t="TYPE4";break;case 15:t="TYPE5";break;case 16:t="TYPE6";break;case 17:t="TYPE7";break;case 18:t="TYPE8";break;case 19:t="TYPE9";break;case 20:t="TYPE10"}return t},handleData:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1];if(!e.accountId&&!/0{1}/.test(e.accountId))return void console.warn("accountId为必填字段！");if("number"!=typeof e.accountType||e.accountType<-1||e.accountType>6&&e.accountType<11||e.accountType>20)return void console.warn("请上传正确的accountType");if(Account.updateAccountInfo("account",e),"register"===t||"login"===t){var n=Object.assign({domainName:t},e);Util.addStoreData([n])}},setAccountInfo:function(e){var t=Util.Store.get(e);t&&("wxUserInfo"===e?this.assignUserInfo(t):"account"===e&&this.assignAccount(t))},updateAccountInfo:function(e, t){Util.Store.set(e,t),"wxUserInfo"===e?this.assignUserInfo(t):"account"===e&&this.assignAccount(t)},assignUserInfo:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};appInfo.user={accounts:[{type:"wechat",name:e.nickName||"",extra:[e]}]}},assignAccount:function(e){e.type=Account.switchType(e.accountType),delete e.accountType,appInfo.appContext.account=e}},accountApi={register:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Account.handleData(e,"register")},login:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Account.handleData(e,"login")}},iapEvent={placeOrder:function(e){if(!iapJudge(e))return!1;var t={orderId:e.orderId,amount:e.amount,currencyType:e.currencyType,domainName:"placeOrder"};Util.addStoreData([t])},orderPaySucc:function(e){if(!iapJudge(e,!0))return!1;var t={orderId:e.orderId,amount:e.amount,currencyType:e.currencyType,payType:e.paymentType,domainName:"orderPaySucc"};Util.addStoreData([t])},cancelOrder:function(e){if(!iapJudge(e))return!1;var t={orderId:e.orderId,amount:e.amount,currencyType:e.currencyType,domainName:"cancelOrder"};Util.addStoreData([t])}},hasDataFlag=!1,onLaunchFn={timeout:null,init:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Util.appLaunchInfo=JSON.parse(JSON.stringify(e)),Util.appLaunchInfo.scene=e.scene?e.scene.toString():"",TDID.init(),onLaunchFn.judgeRequireData(),onLaunchFn.getLocalParams(),customConf.config.getLocation&&onLaunchFn.getLocation(),onLaunchFn.getSystemInfo(),onLaunchFn.getNetwork()},launchRequest:function(){var e={first:!0};request.statusType({domain:"app",name:"init",data:e})},sessionStart:function(e){var t=Util.appLaunchInfo||{},n={status:1,duration:0,name:t.path,scene:t.scene,query:t.query||{},shareTicket:t.shareTicket,referrerInfo:t.referrerInfo};e&&onLaunchFn.setNewSession(),n.start=Util.Store.get("session_time")||Util.timestamp(),n.url=onLaunchFn.getUrl(n.name,n.query),request.statusType({domain:"session",name:"begin",data:n})},getUrl:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=Object.keys(t),a=n.sort(function(e, t){return e>t})||[],i=a.length?e+"?":e;return a.forEach(function(e, n){0!==n&&(i+="&"),i+=e+"="+t[e]}),i},sessionContinue:function(){request.dataType()},sessionEnd:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t={status:3,start:e.startTime,duration:e.duration};request.statusType({domain:"session",name:"end",data:t})},sendTmpSession:function(){onLaunchFn.sessionContinue(),onLaunchFn.startLoop()},startLoop:function(){onLaunchFn.timeout&&(clearTimeout(onLaunchFn.timeout),onLaunchFn.timeout=null);var e=3e3*(Util.sendFailTimes+1);onLaunchFn.timeout=setTimeout(function(){onLaunchFn.sendTmpSession()},e)},judgeRequireData:function(){appInfo.app.appKey||(appInfo.app.appKey="",console.error("请填写您在TalkingData申请的App ID")),appInfo.app.displayName||(appInfo.app.displayName="appname",console.error("请填写您的小程序名称"))},getLocalParams:function(){var e=Util.Store.get("initTime");e?Util.initTime=e:(Util.initTime=Util.timestamp(),Util.Store.set("initTime",Util.initTime),Util.firstInit=!0),appInfo.app.installTime=Util.initTime;var t=Util.appLaunchInfo.query||{},n=t.TDChannelId?t.TDChannelId:"";appInfo.app.channel=n,Account.setAccountInfo("wxUserInfo"),Account.setAccountInfo("account"),onLaunchFn.setNewSession()},setNewSession:function(){Util.sessionId=Util.deviceId(),Util.sessionStartTime=Util.timestamp(),Util.Store.set("session_time",Util.sessionStartTime),appInfo.appContext.sessionId=Util.sessionId,appInfo.appContext.sessionStartTime=Util.sessionStartTime},getLaunchInfo:function(){var e=JSON.parse(JSON.stringify(onLaunchFn.launchOptions));return e.type="appLaunch",e},getAppProfile:function(){if(!hasDataFlag){var e=["device","network","uid"],t=!0;e.forEach(function(e){waitFlag[e]&&(t=!1)}),t&&(hasDataFlag=!0,this.startRequest())}},startRequest:function(){Util.firstInit&&onLaunchFn.launchRequest(),this.sessionStart(),this.startLoop()},getLocation:function(){wx.getLocation({type:"wgs84",complete:function(e){if(e.longitude||e.latitude||e.horizontalAccuracy||e.verticalAccuracy){var t=appInfo.locations[0];t.lng=e.longitude,t.lat=e.latitude,t.hAccuracy=e.horizontalAccuracy,t.vAccuracy=e.verticalAccuracy,t.speed=e.speed,t.altitude=e.altitude,t.ts=(new Date).getTime()}}})},getNetwork:function(){wx.getNetworkType({complete:function(e){var t=appInfo.networks,n=e.networkType;"wifi"===n?(t[0].available=!0,t[0].connected=!0):"unknown"===n?(t[2].available=!0,t[2].connected=!0):"none"!==n&&(t[1].available=!0,t[1].connected=!0,t[1].current.push({type:n})),waitFlag.network=!1,onLaunchFn.getAppProfile()}})},getSystemInfo:function(){wx.getSystemInfo({complete:function(e){if(e.model||e.system||e.SDKVersion){var t={model:e.model,pixel:e.screenWidth+"*"+e.screenHeight+"*"+e.pixelRatio,densityDpi:e.pixelRatio,brand:e.brand},n={os:e.system,local:e.language,language:"zh_CN",osVersionCode:e.version,timezone:-(new Date).getTimezoneOffset()/60,mpVersion:e.SDKVersion};appInfo.device.hardwareConfig=t,appInfo.device.softwareConfig=n}waitFlag.device=!1,onLaunchFn.getAppProfile()}})}},eventHandle={event:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Util.getEventId(e.id);if(t){var n={};n.eventId=t,n.label=Util.getEventId(e.label),n.count=e.count||1,n.params=e.params,n.startTime=Util.timestamp(),void 0!==e.value?"number"!=typeof e.value?console.error('自定义事件"'+t+'"中value对应的值的类型需为Number类型'):isNaN(e.value)?console.error('自定义事件"'+t+'"中请输入有效的Number类型数值'):(n.value=e.value,Util.addStoreData([n])):Util.addStoreData([n])}},share:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Util.eventHandle("WeappShare",e)},pullDownRefresh:function(){customConf.config.autoOnPullDownRefresh||Util.eventHandle("WeappPullDownRefresh")},reachBottom:function(){customConf.config.autoOnReachBottom||Util.eventHandle("WeappReachBottom")},setProfile:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e.accountId||/0{1}/.test(e.accountId)?e.accountType||/0{1}/.test(e.accountType)?void Account.updateAccountInfo("account",e):void console.warn("accountType为必填字段！"):void console.warn("accountId为必填字段！")},setWXUserInfo:function(e){"object"!==(void 0===e?"undefined":_typeof(e))||e instanceof Array?console.warn("setUserInfo接口只接受json对象作为参数"):Account.updateAccountInfo("wxUserInfo",e)},Profile:accountApi,iap:iapEvent},appHandle={isHide2Show:!1,appIsHide:!1,lastHideTime:0,show:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(appHandle.appIsHide=!1,appHandle.getlastTmpData(),appHandle.isHide2Show){var t=Util.Store.get("TMP_time_end_"+Util.sessionId),n=e.scene?e.scene.toString():"";if(e.scene&&n===Util.appLaunchInfo.scene){Util.timestamp()-t>3e4?appHandle.sessionRestart(t):(appHandle.lastHideTime=t,Util.Store.remove("TMP_time_end_"+Util.sessionId))}else Util.appLaunchInfo=JSON.parse(JSON.stringify(e)),Util.appLaunchInfo.scene=n,appHandle.sessionRestart(t);appHandle.isHide2Show=!1,onLaunchFn.startLoop()}},sessionRestart:function(e){var t=Util.Store.get("TMP_time_start_"+Util.sessionId),n={startTime:t,duration:parseInt((e-t)/1e3)};onLaunchFn.sessionEnd(n),Util.Store.remove("TMP_time_start_"+Util.sessionId),Util.Store.remove("TMP_time_end_"+Util.sessionId),Util.Store.remove("session_time"),onLaunchFn.sessionStart(!0),appHandle.lastHideTime=0},hide:function(){appHandle.appIsHide=!0,clearTimeout(onLaunchFn.timeout),onLaunchFn.timeout=null,onLaunchFn.sessionContinue(),appHandle.isHide2Show=!0;var e=Util.Store.get("session_time"),t=Util.timestamp(),n=appHandle.lastHideTime?t-appHandle.lastHideTime:t-e;Util.Store.set("TMP_time_start_"+Util.sessionId,e),Util.Store.set("TMP_time_end_"+Util.sessionId,t);var a={start:t,duration:parseInt((t-e)/1e3),durationHide:parseInt(n/1e3)};request.statusType({domain:"session",name:"hide",data:a})},getlastTmpData:function(){var e=[],t=wx.getStorageInfoSync().keys||[],n=void 0,a=void 0;t&&t.length&&(n=t.filter(function(e){return e.indexOf("TDSDK_EVENT")>-1}),a=t.filter(function(e){return e.indexOf("TDSDK_RESEND")>-1})),n&&n.length&&(n.forEach(function(t){var n={};t.split("_")[2];n.id=t.split("_")[2],n.time=n.id.split("-")[1],e.push(n)}),appHandle.sendLastTmpData(e)),a&&a.length&&a.forEach(function(e){wx.getStorage({key:e,success:function(t){Util.getRequestData(t.data),wx.removeStorage({key:e,success:function(e){}})}})})},sendLastTmpData:function(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach(function(e){request.dataType(e.id,e.time)})}},pageHandle={curPagePath:"",refer:"",pageTime:0,pageQuery:{},show:function(){onLaunchFn.startLoop();var e=getCurrentPages(),t=e[e.length-1];""!==pageHandle.curPagePath&&(pageHandle.refer=pageHandle.curPagePath),pageHandle.curPagePath=t.__route__,pageHandle.pageTime=Util.timestamp(),pageHandle.pageQuery=t.options},hide:function(){var e=Util.timestamp();clearTimeout(onLaunchFn.timeout),onLaunchFn.timeout=null;var t=[{name:pageHandle.curPagePath,from:pageHandle.refer||"",query:pageHandle.pageQuery,scene:Util.appLaunchInfo.scene,duration:parseInt((e-pageHandle.pageTime)/1e3),startTime:pageHandle.pageTime,pageEvent:!0,leaveTime:e}];Util.addStoreData(t)}},appBak=App,pageBak=Page;App=function(e){var t={onLaunch:onLaunchFn.init,onShow:appHandle.show,onHide:appHandle.hide};Object.keys(t).forEach(function(n){resetFn(e,n,t[n])}),e.td_app_sdk=eventHandle,appBak(e)},Page=function(e){var t={onShow:pageHandle.show,onHide:pageHandle.hide,onUnload:pageHandle.hide};customConf.config.autoOnPullDownRefresh&&(t.onPullDownRefresh=function(){Util.eventHandle("WeappPullDownRefresh")}),customConf.config.autoOnReachBottom&&(t.onReachBottom=function(){Util.eventHandle("WeappReachBottom")}),Object.keys(t).forEach(function(n){resetFn(e,n,t[n])}),pageBak(e)};